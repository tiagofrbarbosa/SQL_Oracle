SELECT servico
       , data
         , tipo_atendimento
         , consultas_ofertadas
         , Encaixes_Marcados
         , Consultas_Marcadas
         , Encaixes_Marcados + Consultas_Marcadas total_agendado
         , Consultas_Atendidas
         , (Encaixes_Marcados + Consultas_Marcadas) -  Consultas_Atendidas nao_atendido
  FROM (
                SELECT ds_ser_dis                                                   Servico, 
                       dt_agenda                                                    Data, 
                                ds_tip_mar                                          Tipo_Atendimento,
                       Sum(qt_consultas) Consultas_Ofertadas, 
                       Sum(qt_encaixes_marcados)                                    Encaixes_Marcados, 
                       Sum(qt_consultas_marcadas) - Sum(qt_encaixes_marcados)       Consultas_Marcadas, 
                       Sum(atendimento_realizado)                                   Consultas_Atendidas 
                FROM (
                    SELECT 
                        ser.ds_ser_dis,
                        ac.dt_agenda,
                        mar.ds_tip_mar,   
                        Nvl(ac.qt_atendimento,0)       qt_consultas,
                        Nvl(ac.qt_encaixes_marcados,0) qt_encaixes_marcados,
                        Count(Nvl(ac.qt_marcados,0))   qt_consultas_marcadas,
                        Count(cd_atendimento)          atendimento_realizado
                    FROM 
                        dbamv.agenda_central ac,
                        dbamv.it_agenda_central it,
                        dbamv.tip_mar mar,
                        dbamv.ser_dis ser
                    WHERE 
                        To_Date(ac.dt_agenda,'DD/MM/YYYY') BETWEEN To_Date(:DT_INICIAL,'DD/MM/YYYY') AND To_Date(:DT_FINAL,'DD/MM/YYYY') 
                    AND ac.cd_agenda_central = it.cd_agenda_central(+)
                    AND it.cd_tip_mar        = mar.cd_tip_mar
                    AND ac.cd_multi_empresa  = 1
                    AND it.cd_ser_dis        = ser.cd_ser_dis(+)         
                    AND ser.ds_ser_dis  LIKE Decode(:TP_SERVICO,'TODOS','%',:TP_SERVICO)
                    GROUP BY ser.ds_ser_dis, ac.dt_agenda, mar.ds_tip_mar, qt_atendimento, qt_encaixes_marcados, qt_marcados
                     ) 
               GROUP BY ds_ser_dis, dt_agenda, ds_tip_mar ORDER BY dt_agenda ASC